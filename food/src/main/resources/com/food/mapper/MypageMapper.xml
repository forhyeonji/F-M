<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.food.mapper.MypageMapper">

	<resultMap type="com.food.model.CommunityReplyVO" id="sqlmyreply">
		<id property="rno" column="rno"/>
		<id property="context" column="Recontext"/>
		<id property="reg_dt" column="Rereg_dt"/>
		<id property="user_id" column="Reuser_id"/>
		<id property="bno" column="Rebno"/>
	</resultMap>
	
	<resultMap type="com.food.model.MypageVO" id="Mypage">
		<collection property="reply" resultMap="sqlmyreply"/>
	</resultMap>

	<select id="mypage" resultType="com.food.model.UserVO">
		select * from tb_user where user_id=#{user_id}
	</select>
	
	<select id="profile" resultType="com.food.model.UserVO">
		select * from tb_user where user_id=#{user_id}
	</select>
	
	<update id="edit">
		update tb_user set 
			user_pw=#{user_pw},
			user_zip=#{user_zip}, user_addr1=#{user_addr1},
			user_addr2=#{user_addr2}, user_phone=#{user_phone}, 
			user_email=#{user_email}
		where tb_user.user_id=#{user_id}
	</update>
	
	<delete id="resignPost">
		delete from tb_user 
		where user_id=#{user_id}		
	</delete>

	<sql id="shop">
		from tb_shop sh where sh.prodnum = c.c_prodnum
	</sql>
	
	<select id="cartlist" resultType="com.food.model.CartVO">
		select c.*, 
				(select NAME <include refid="shop"></include>) as s_name,
				(select CONTENT <include refid="shop"></include>) as s_content,
				(select price2 <include refid="shop"></include>) as s_price
		from tb_cart c
		where c.user_id = #{user_id}
	</select>
	
	
	<select id="mywrite" resultType="com.food.model.MypageVO">
		select * 
		from (
				select @rownum:= @rownum+1 rownum, co.*
				from tb_community co, (select @rownum:=0) as tmp	
	
			<if test = "user_id != null">
             	where user_id=#{user_id}
            </if>
			<if test = "keyword != null">
             	and title like concat('%',#{keyword},'%')
            </if>
            						
			order by reg_dt desc
			 ) as mywrite
			 <![CDATA[
			 where rownum > (#{pageNum}-1)*#{amount} and rownum <= #{pageNum}*#{amount}
			 ]]>
	</select>

	<select id="myreply" parameterType="com.food.model.CommunityReplyVO" resultType="com.food.model.MypageVO">
		select *
		from (
			select @rownum:=@rownum+1 rownum, re.*
			from tb_community_reply re, (select @rownum:=0) as tmp
	
			<if test = "user_id != null">
             	where user_id=#{user_id}
            </if>
	
		    order by rno desc
		) as reply
		<![CDATA[
		where rownum >(#{pageNum}-1)*#{amount} and rownum <= #{pageNum}*#{amount}
		]]>
	</select>
	
	<select id="retotal" resultType="int">
		select count(*) from tb_community_reply
		where user_id=#{user_id}
	</select>
	
	<select id="replycnt" resultType="int">
		select count(*) as replycnt 
		from tb_community_reply
		where bno=#{bno}
	</select>
	
	<select id="total" resultType="int">
		select count(*) from tb_community 
		<if test="user_id != null and user_id !=''">
			where user_id=#{user_id}
		</if>
		<if test = "keyword != null">
            and title like concat('%',#{keyword},'%')
        </if>						
	</select>
	
	<select id="mywritedetail" resultType="com.food.model.MypageVO">
		select * from tb_community where bno=#{bno}
	</select>
  
</mapper>